@page "/daily-production"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject ProductionOrderService OrderService
@inject ProductService ProductService
@inject ISnackbar Snackbar
@inject LocalizationService Localization
@implements IDisposable

<PageTitle>@Localization.Translate("DailyProductionEntry") - TinacoPro</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@Localization.Translate("DailyProductionEntry")</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">@Localization.Translate("EnterProductionForDate")</MudText>
    
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="6">
            <MudDatePicker @bind-Date="productionDate" Label="@Localization.Translate("ProductionDate")" Variant="Variant.Outlined" Required="true" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSelect @bind-Value="selectedShift" Label="@Localization.Translate("Shift")" Variant="Variant.Outlined" Required="true" T="string">
                <MudSelectItem T="string" Value="@("Morning")">@Localization.Translate("Morning")</MudSelectItem>
                <MudSelectItem T="string" Value="@("Afternoon")">@Localization.Translate("Afternoon")</MudSelectItem>
                <MudSelectItem T="string" Value="@("Night")">@Localization.Translate("Night")</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudTextField @bind-Value="productionNotes" 
                  Label="@Localization.Translate("ProductionNotes")" 
                  Variant="Variant.Outlined" 
                  Lines="3" 
                  Placeholder="@Localization.Translate("Notes")"
                  Class="mb-4" />
    
    @if (products == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (products.Any())
    {
        <MudText Typo="Typo.subtitle1" Class="mb-3"><strong>@Localization.Translate("EnterQuantitiesForEachProduct")</strong></MudText>
        
        <MudGrid>
            @foreach (var product in products.Where(p => p.IsActive).OrderBy(p => p.Capacity))
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudNumericField @bind-Value="productQuantities[product.Id]" 
                                     Label="@product.Name" 
                                     Variant="Variant.Outlined" 
                                     Min="0" 
                                     Adornment="Adornment.End" 
                                     AdornmentText="@Localization.Translate("Units")" />
                </MudItem>
            }
        </MudGrid>
        
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" 
                   OnClick="SaveDailyProduction" Class="mt-4" Disabled="@(!productionDate.HasValue)">
            @Localization.Translate("SaveDailyProduction")
        </MudButton>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">@Localization.Translate("NoActiveProductsFound")</MudAlert>
    }
</MudPaper>

<MudText Typo="Typo.h5" Class="mb-3">@Localization.Translate("HistoricalDailyProduction")</MudText>

@if (historicalOrders == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (historicalOrders.Any())
{
    <MudTable Items="@historicalOrders" Hover="true" Striped="true" Dense="true" Elevation="2" GroupBy="@_groupDefinition">
        <HeaderContent>
            <MudTh>@Localization.Translate("Product")</MudTh>
            <MudTh>@Localization.Translate("Quantity")</MudTh>
            <MudTh>@Localization.Translate("Shift")</MudTh>
            <MudTh>@Localization.Translate("Status")</MudTh>
            <MudTh>@Localization.Translate("OrderNumber")</MudTh>
            <MudTh>@Localization.Translate("Notes")</MudTh>
        </HeaderContent>
        <GroupHeaderTemplate>
            <MudTh Class="mud-table-cell-custom-group" colspan="6">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" /> 
                    @context.Key
                </MudText>
            </MudTh>
        </GroupHeaderTemplate>
        <RowTemplate>
            <MudTd DataLabel="@Localization.Translate("Product")">@context.ProductName</MudTd>
            <MudTd DataLabel="@Localization.Translate("Quantity")">@context.Quantity</MudTd>
            <MudTd DataLabel="@Localization.Translate("Shift")">
                <MudChip T="string" Color="@GetShiftColor(context.Shift)" Size="Size.Small" Variant="Variant.Outlined">@context.Shift</MudChip>
            </MudTd>
            <MudTd DataLabel="@Localization.Translate("Status")">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
            </MudTd>
            <MudTd DataLabel="@Localization.Translate("OrderNumber")">@context.OrderNumber</MudTd>
            <MudTd DataLabel="@Localization.Translate("Notes")">
                @if (!string.IsNullOrWhiteSpace(context.Notes))
                {
                    <MudTooltip Text="@context.Notes">
                        <MudIcon Icon="@Icons.Material.Filled.Comment" Size="Size.Small" Color="Color.Info" />
                    </MudTooltip>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudAlert Severity="Severity.Info">@Localization.Translate("NoProductionHistoryFound")</MudAlert>
}

@code {
    private DateTime? productionDate = DateTime.Today;
    private string selectedShift = "Morning";
    private string productionNotes = string.Empty;
    private IEnumerable<ProductionOrderDto>? historicalOrders;
    private IEnumerable<ProductDto>? products;
    private Dictionary<int, int> productQuantities = new();
    
    private TableGroupDefinition<ProductionOrderDto> _groupDefinition = new()
    {
        GroupName = "Date",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = false,
        Selector = (e) => e.OrderDate.ToString("yyyy-MM-dd")
    };

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        await LoadProducts();
        await LoadHistoricalOrders();
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadProducts()
    {
        products = await ProductService.GetAllProductsAsync();
        
        // Initialize quantities dictionary with all products
        if (products != null)
        {
            foreach (var product in products.Where(p => p.IsActive))
            {
                productQuantities[product.Id] = 0;
            }
        }
    }

    private async Task LoadHistoricalOrders()
    {
        var allOrders = await OrderService.GetAllOrdersAsync();
        historicalOrders = allOrders.OrderByDescending(o => o.OrderDate);
    }

    private async Task SaveDailyProduction()
    {
        if (!productionDate.HasValue)
            return;

        int ordersCreated = 0;

        try
        {
            foreach (var kvp in productQuantities.Where(q => q.Value > 0))
            {
                var createDto = new CreateProductionOrderDto
                {
                    ProductId = kvp.Key,
                    Quantity = kvp.Value,
                    Shift = selectedShift,
                    Notes = string.IsNullOrWhiteSpace(productionNotes) 
                        ? $"Daily production entry for {productionDate.Value:yyyy-MM-dd}" 
                        : productionNotes
                };
                
                await OrderService.CreateOrderAsync(createDto);
                ordersCreated++;
            }

            if (ordersCreated > 0)
            {
                Snackbar.Add($"Production orders created successfully for {ordersCreated} product(s)!", Severity.Success);
                
                // Reset form
                foreach (var key in productQuantities.Keys.ToList())
                {
                    productQuantities[key] = 0;
                }
                productionDate = DateTime.Today;
                selectedShift = "Morning";
                productionNotes = string.Empty;
                
                // Reload historical orders
                await LoadHistoricalOrders();
            }
            else
            {
                Snackbar.Add("Please enter quantities for at least one product.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating production orders: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Pending" => Color.Warning,
            "InProgress" => Color.Info,
            "Completed" => Color.Success,
            "Cancelled" => Color.Error,
            _ => Color.Default
        };
    }

    private Color GetShiftColor(string shift)
    {
        return shift switch
        {
            "Morning" => Color.Info,
            "Afternoon" => Color.Warning,
            "Night" => Color.Secondary,
            _ => Color.Default
        };
    }
}

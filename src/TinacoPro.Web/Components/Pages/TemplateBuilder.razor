@page "/template-builder"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject ProductTemplateService TemplateService
@inject RawMaterialService MaterialService
@inject ISnackbar Snackbar
@inject LocalizationService Localization
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudText Typo="Typo.h4" Class="mb-4">@Localization.Translate("ProductTemplateBuilder")</MudText>
    
    <MudGrid>
        <!-- Left Panel: Template List -->
        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">@Localization.Translate("Templates")</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" 
                                   OnClick="OpenNewTemplateDialog">@Localization.Translate("NewTemplate")</MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (templates == null)
                    {
                        <MudProgressCircular Indeterminate="true" />
                    }
                    else if (!templates.Any())
                    {
                        <MudAlert Severity="Severity.Info">@Localization.Translate("NoTemplatesFound")</MudAlert>
                    }
                    else
                    {
                        <MudList Clickable="true" T="string">
                            @foreach (var template in templates)
                            {
                                <MudListItem OnClick="@(() => SelectTemplate(template))" 
                                             Selected="@(selectedTemplate?.Id == template.Id)" T="string">
                                    <div class="d-flex justify-space-between align-center">
                                        <div>
                                            <MudText Typo="Typo.body1">@template.Name</MudText>
                                            <MudText Typo="Typo.caption">@template.ModelType</MudText>
                                        </div>
                                        <MudChip T="string" Size="Size.Small" Color="@(template.IsActive ? Color.Success : Color.Default)">
                                            @(template.IsActive ? Localization.Translate("Active") : Localization.Translate("Inactive"))
                                        </MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Right Panel: Template Details and Parts -->
        <MudItem xs="12" md="8">
            @if (selectedTemplate != null)
            {
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@selectedTemplate.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@selectedTemplate.ModelType</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" 
                                           OnClick="OpenEditTemplateDialog" Size="Size.Small" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                           OnClick="DeleteTemplate" Size="Size.Small" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2" Class="mb-3">@selectedTemplate.Description</MudText>
                        
                        <MudDivider Class="my-3" />
                        
                        <MudText Typo="Typo.h6" Class="mb-2">@Localization.Translate("CostSummary")</MudText>
                        <MudGrid>
                            <MudItem xs="6" sm="3">
                                <MudText Typo="Typo.caption">@Localization.Translate("MaterialCost")</MudText>
                                <MudText Typo="Typo.body1" Color="Color.Primary">
                                    $@selectedTemplate.TotalMaterialCost.ToString("F2")
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudText Typo="Typo.caption">@Localization.Translate("LaborCost")</MudText>
                                <MudText Typo="Typo.body1" Color="Color.Secondary">
                                    $@selectedTemplate.TotalLaborCost.ToString("F2")
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudText Typo="Typo.caption">@Localization.Translate("EstTime")</MudText>
                                <MudText Typo="Typo.body1">
                                    @selectedTemplate.TotalEstimatedMinutes min
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudText Typo="Typo.caption">@Localization.Translate("TotalCost")</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">
                                    $@((selectedTemplate.TotalMaterialCost + selectedTemplate.TotalLaborCost).ToString("F2"))
                                </MudText>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-3" />

                        <div class="d-flex justify-space-between align-center mb-2">
                            <MudText Typo="Typo.h6">@Localization.Translate("Parts")</MudText>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" 
                                       StartIcon="@Icons.Material.Filled.Add" OnClick="OpenNewPartDialog">
                                @Localization.Translate("AddPart")
                            </MudButton>
                        </div>

                        @if (selectedTemplate.RootParts == null || !selectedTemplate.RootParts.Any())
                        {
                            <MudAlert Severity="Severity.Info">@Localization.Translate("NoPartsFound")</MudAlert>
                        }
                        else
                        {
                            <MudTreeView T="TreeItemData" @bind-SelectedValue="selectedTreeItem" Hover="true" Dense="true">
                                @foreach (var part in selectedTemplate.RootParts.OrderBy(p => p.Position))
                                {
                                    @RenderTreeItem(part, 0)
                                }
                            </MudTreeView>
                        }
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                            @Localization.Translate("SelectTemplatePrompt")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

<!-- Template Dialog -->
<MudDialog @bind-Visible="showTemplateDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingTemplate?.Id > 0 ? Localization.Translate("EditTemplate") : Localization.Translate("NewTemplate"))</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="editingTemplate.Name" Label="@Localization.Translate("TemplateName")" Required="true" />
        <MudTextField @bind-Value="editingTemplate.ModelType" Label="@Localization.Translate("ModelType")" Required="true" Class="mt-3" />
        <MudTextField @bind-Value="editingTemplate.Description" Label="@Localization.Translate("Description")" Lines="3" Class="mt-3" />
        <MudSwitch @bind-Value="editingTemplate.IsActive" Label="@Localization.Translate("Active")" Color="Color.Success" Class="mt-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showTemplateDialog = false)">@Localization.Translate("Cancel")</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveTemplate">@Localization.Translate("Save")</MudButton>
    </DialogActions>
</MudDialog>

<!-- Part Dialog -->
<MudDialog @bind-Visible="showPartDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingPart?.Id > 0 ? Localization.Translate("EditPart") : Localization.Translate("AddPart"))</MudText>
    </TitleContent>
    <DialogContent>
        <MudSelect @bind-Value="editingPart.ParentPartId" Label="@Localization.Translate("ParentPart")" T="int?" Clearable="true">
            <MudSelectItem T="int?" Value="null">@Localization.Translate("None") (@Localization.Translate("RootLevel"))</MudSelectItem>
            @foreach (var part in GetAvailableParentParts())
            {
                <MudSelectItem T="int?" Value="@part.Id">@part.Name</MudSelectItem>
            }
        </MudSelect>

        <MudSelect @bind-Value="editingPart.PartType" Label="@Localization.Translate("PartType")" Required="true" Class="mt-3">
            <MudSelectItem Value="@("Assembly")">@Localization.Translate("Assembly")</MudSelectItem>
            <MudSelectItem Value="@("Material")">@Localization.Translate("Material")</MudSelectItem>
            <MudSelectItem Value="@("Component")">@Localization.Translate("Component")</MudSelectItem>
            <MudSelectItem Value="@("Process")">@Localization.Translate("Process")</MudSelectItem>
        </MudSelect>

        <MudTextField @bind-Value="editingPart.Name" Label="@Localization.Translate("PartName")" Required="true" Class="mt-3" />

        @if (editingPart.PartType == "Material")
        {
            <MudAutocomplete T="RawMaterialDto" 
                             @bind-Value="selectedMaterial"
                             Label="@Localization.Translate("RawMaterial")" 
                             SearchFunc="@SearchMaterials"
                             ToStringFunc="@(m => m == null ? "" : $"{m.Name} ({m.Code})")"
                             Class="mt-3"
                             Clearable="true"
                             Dense="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="true"
                             CoerceValue="true">
                <ItemTemplate Context="material">
                    <div class="d-flex justify-space-between align-center" style="width: 100%;">
                        <div>
                            <MudText Typo="Typo.body2">@material.Name (@material.Code)</MudText>
                            <MudText Typo="Typo.caption" Color="@(material.IsLowStock ? Color.Warning : Color.Secondary)">
                                Stock: @material.CurrentStock.ToString("F2") @material.Unit | Cost: $@material.UnitCost.ToString("F2")/@material.Unit
                            </MudText>
                        </div>
                        @if (material.IsLowStock)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@Localization.Translate("LowStock")</MudChip>
                        }
                    </div>
                </ItemTemplate>
            </MudAutocomplete>

            <div class="d-flex justify-space-between align-center mt-2">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @if (selectedMaterial != null)
                    {
                        <text>Available: @selectedMaterial.CurrentStock.ToString("F2") @selectedMaterial.Unit</text>
                    }
                </MudText>
                <MudButton Variant="Variant.Text" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" 
                           OnClick="OpenQuickAddMaterialDialog" Color="Color.Primary">
                    @Localization.Translate("QuickAddMaterial")
                </MudButton>
            </div>
        }

        <MudNumericField @bind-Value="editingPart.Quantity" Label="@Localization.Translate("Quantity")" T="decimal" Min="0" Class="mt-3" />
        <MudTextField @bind-Value="editingPart.Unit" Label="@Localization.Translate("Unit")" Placeholder="kg, pcs, liters" Class="mt-3" />
        <MudNumericField @bind-Value="editingPart.UnitCost" Label="@Localization.Translate("UnitCost")" T="decimal" Min="0" Format="F2" Class="mt-3" />
        <MudNumericField @bind-Value="editingPart.LaborCost" Label="@Localization.Translate("LaborCost")" T="decimal" Min="0" Format="F2" Class="mt-3" />
        <MudNumericField @bind-Value="editingPart.EstimatedMinutes" Label="@Localization.Translate("EstimatedMinutes")" T="int" Min="0" Class="mt-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showPartDialog = false)">@Localization.Translate("Cancel")</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SavePart">@Localization.Translate("Save")</MudButton>
    </DialogActions>
</MudDialog>

<!-- Quick Add Material Dialog -->
<MudDialog @bind-Visible="showQuickAddMaterialDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">@Localization.Translate("NewMaterial")</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="quickAddMaterial.Name" Label="@Localization.Translate("MaterialName")" Required="true" />
        <MudTextField @bind-Value="quickAddMaterial.Code" Label="@Localization.Translate("MaterialCode")" Required="true" Class="mt-3" />
        <MudTextField @bind-Value="quickAddMaterial.Unit" Label="@Localization.Translate("Unit")" Placeholder="kg, pcs, liters" Class="mt-3" />
        <MudNumericField @bind-Value="quickAddMaterial.UnitCost" Label="@Localization.Translate("UnitCost")" T="decimal" Min="0" Format="F2" Class="mt-3" />
        <MudNumericField @bind-Value="quickAddMaterial.MinimumStock" Label="@Localization.Translate("MinimumStock")" T="decimal" Min="0" Class="mt-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showQuickAddMaterialDialog = false)">@Localization.Translate("Cancel")</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveQuickAddMaterial">@Localization.Translate("NewMaterial")</MudButton>
    </DialogActions>
</MudDialog>

<!-- Context Menu -->
@if (showContextMenu && contextMenuPart != null)
{
    <div style="position: fixed; top: @(contextMenuY)px; left: @(contextMenuX)px; z-index: 9999; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 4px;"
         @onclick:stopPropagation="true">
        <MudList T="string" Clickable="true" Dense="true">
            <MudListItem T="string" OnClick="@(() => OpenAddChildDialog(contextMenuPart))">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.body2">@Localization.Translate("AddChildPart")</MudText>
                </div>
            </MudListItem>
            <MudListItem T="string" OnClick="@(() => OpenEditPartDialog(contextMenuPart))">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.body2">@Localization.Translate("EditPart")</MudText>
                </div>
            </MudListItem>
            <MudListItem T="string" OnClick="@(() => DeletePart(contextMenuPart.Id))">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" Class="mr-2" />
                    <MudText Typo="Typo.body2" Color="Color.Error">@Localization.Translate("DeletePart")</MudText>
                </div>
            </MudListItem>
            <MudDivider />
            <MudListItem T="string" OnClick="@(() => MovePartUp(contextMenuPart))">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.body2">@Localization.Translate("MoveUp")</MudText>
                </div>
            </MudListItem>
            <MudListItem T="string" OnClick="@(() => MovePartDown(contextMenuPart))">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.body2">@Localization.Translate("MoveDown")</MudText>
                </div>
            </MudListItem>
        </MudList>
    </div>
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998;" @onclick="HideContextMenu"></div>
}

@code {
    private List<ProductTemplateDto> templates = new();
    private List<RawMaterialDto> materials = new();
    private ProductTemplateDto? selectedTemplate;
    private ProductTemplateDto editingTemplate = new();
    private TemplatePartDto editingPart = new();
    private bool showTemplateDialog;
    private bool showPartDialog;
    private bool showQuickAddMaterialDialog;
    private CreateRawMaterialDto quickAddMaterial = new();
    private TreeItemData? selectedTreeItem;
    private TemplatePartDto? contextMenuPart;
    private bool showContextMenu;
    private double contextMenuX;
    private double contextMenuY;

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        await LoadData();
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadData()
    {
        templates = (await TemplateService.GetAllTemplatesAsync()).ToList();
        materials = (await MaterialService.GetAllMaterialsAsync()).ToList();
    }

    private async Task SelectTemplate(ProductTemplateDto template)
    {
        selectedTemplate = await TemplateService.GetTemplateByIdAsync(template.Id);
        selectedTreeItem = null;
        StateHasChanged();
    }

    private void OpenNewTemplateDialog()
    {
        editingTemplate = new ProductTemplateDto { IsActive = true };
        showTemplateDialog = true;
    }

    private void OpenEditTemplateDialog()
    {
        if (selectedTemplate != null)
        {
            editingTemplate = new ProductTemplateDto
            {
                Id = selectedTemplate.Id,
                Name = selectedTemplate.Name,
                ModelType = selectedTemplate.ModelType,
                Description = selectedTemplate.Description,
                IsActive = selectedTemplate.IsActive
            };
            showTemplateDialog = true;
        }
    }

    private async Task SaveTemplate()
    {
        try
        {
            if (editingTemplate.Id > 0)
            {
                await TemplateService.UpdateTemplateAsync(editingTemplate);
                Snackbar.Add(Localization.Translate("TemplateUpdated"), Severity.Success);
            }
            else
            {
                await TemplateService.CreateTemplateAsync(editingTemplate);
                Snackbar.Add(Localization.Translate("TemplateCreated"), Severity.Success);
            }

            showTemplateDialog = false;
            await LoadData();

            if (selectedTemplate != null)
            {
                selectedTemplate = await TemplateService.GetTemplateByIdAsync(selectedTemplate.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteTemplate()
    {
        if (selectedTemplate != null)
        {
            try
            {
                await TemplateService.DeleteTemplateAsync(selectedTemplate.Id);
                Snackbar.Add(Localization.Translate("TemplateDeleted"), Severity.Success);
                selectedTemplate = null;
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private void OpenNewPartDialog()
    {
        if (selectedTemplate != null)
        {
            editingPart = new TemplatePartDto
            {
                ProductTemplateId = selectedTemplate.Id,
                Quantity = 1,
                Position = CountAllParts(selectedTemplate.RootParts) + 1
            };
            showPartDialog = true;
        }
    }

    private int CountAllParts(List<TemplatePartDto> parts)
    {
        int count = parts?.Count ?? 0;
        foreach (var part in parts ?? Enumerable.Empty<TemplatePartDto>())
        {
            count += CountAllParts(part.Children);
        }
        return count;
    }

    private void OpenEditPartDialog(TemplatePartDto part)
    {
        editingPart = new TemplatePartDto
        {
            Id = part.Id,
            ProductTemplateId = part.ProductTemplateId,
            ParentPartId = part.ParentPartId,
            Name = part.Name,
            PartType = part.PartType,
            Quantity = part.Quantity,
            Unit = part.Unit,
            UnitCost = part.UnitCost,
            LaborCost = part.LaborCost,
            EstimatedMinutes = part.EstimatedMinutes,
            RawMaterialId = part.RawMaterialId,
            Position = part.Position
        };
        showPartDialog = true;
    }

    private async Task SavePart()
    {
        try
        {
            if (editingPart.Id > 0)
            {
                await TemplateService.UpdatePartAsync(editingPart);
                Snackbar.Add(Localization.Translate("PartUpdated"), Severity.Success);
            }
            else
            {
                await TemplateService.AddPartAsync(editingPart);
                Snackbar.Add(Localization.Translate("PartAdded"), Severity.Success);
            }

            showPartDialog = false;

            if (selectedTemplate != null)
            {
                selectedTemplate = await TemplateService.GetTemplateByIdAsync(selectedTemplate.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletePart(int partId)
    {
        try
        {
            await TemplateService.DeletePartAsync(partId);
            Snackbar.Add(Localization.Translate("PartDeleted"), Severity.Success);

            if (selectedTemplate != null)
            {
                selectedTemplate = await TemplateService.GetTemplateByIdAsync(selectedTemplate.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    // Material selection enhancement methods
    private Task<IEnumerable<RawMaterialDto>> SearchMaterials(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(materials.AsEnumerable());

        var filtered = materials.Where(m => 
            m.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            m.Code.Contains(value, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(m => m.IsLowStock) // Show low stock items first
            .ThenBy(m => m.Name);

        return Task.FromResult(filtered.AsEnumerable());
    }

    private RawMaterialDto? selectedMaterial
    {
        get => materials.FirstOrDefault(m => m.Id == editingPart.RawMaterialId);
        set
        {
            if (value != null)
            {
                editingPart.RawMaterialId = value.Id;
                // Auto-populate unit cost from selected material
                editingPart.UnitCost = value.UnitCost;
                // Auto-populate unit from material
                if (string.IsNullOrWhiteSpace(editingPart.Unit))
                {
                    editingPart.Unit = value.Unit;
                }
            }
            else
            {
                editingPart.RawMaterialId = null;
            }
            StateHasChanged();
        }
    }

    private void OpenQuickAddMaterialDialog()
    {
        quickAddMaterial = new CreateRawMaterialDto();
        showQuickAddMaterialDialog = true;
    }

    private async Task SaveQuickAddMaterial()
    {
        try
        {
            var newMaterial = await MaterialService.CreateMaterialAsync(quickAddMaterial);
            Snackbar.Add(Localization.Translate("MaterialAdded"), Severity.Success);
            
            // Reload materials list
            materials = (await MaterialService.GetAllMaterialsAsync()).ToList();
            
            // Auto-select the new material
            selectedMaterial = materials.FirstOrDefault(m => m.Id == newMaterial.Id);
            
            showQuickAddMaterialDialog = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private List<TemplatePartDto> GetAvailableParentParts()
    {
        if (selectedTemplate?.RootParts == null) return new List<TemplatePartDto>();

        var allParts = new List<TemplatePartDto>();
        CollectAllParts(selectedTemplate.RootParts, allParts);

        // Filter out the part being edited (can't be its own parent)
        return allParts
            .Where(p => p.Id != editingPart.Id)
            .OrderBy(p => p.Name)
            .ToList();
    }

    private void CollectAllParts(List<TemplatePartDto> parts, List<TemplatePartDto> collection)
    {
        foreach (var part in parts ?? Enumerable.Empty<TemplatePartDto>())
        {
            collection.Add(part);
            CollectAllParts(part.Children, collection);
        }
    }

    // TreeView helper class
    public class TreeItemData
    {
        public TemplatePartDto Part { get; set; } = null!;
        public string Icon { get; set; } = string.Empty;
        public string DisplayText { get; set; } = string.Empty;
    }

    private RenderFragment RenderTreeItem(TemplatePartDto part, int depth)
    {
        return builder =>
        {
            var icon = part.PartType switch
            {
                "Assembly" => Icons.Material.Filled.AccountTree,
                "Material" => Icons.Material.Filled.Science,
                "Component" => Icons.Material.Filled.Build,
                "Process" => Icons.Material.Filled.Settings,
                _ => Icons.Material.Filled.Circle
            };

            var treeItemData = new TreeItemData
            {
                Part = part,
                Icon = icon,
                DisplayText = part.Name
            };

            builder.OpenComponent<MudTreeViewItem<TreeItemData>>(0);
            builder.AddAttribute(1, "Value", treeItemData);
            builder.AddAttribute(2, "Icon", icon);
            builder.AddAttribute(3, "Text", part.Name);
            builder.AddAttribute(4, "CanExpand", part.Children?.Any() == true);
            builder.AddAttribute(5, "Expanded", true);
            builder.AddAttribute(6, "ChildContent", (RenderFragment)(contentBuilder =>
            {
                // Item content
                contentBuilder.OpenElement(0, "div");
                contentBuilder.AddAttribute(1, "class", "d-flex justify-space-between align-center flex-grow-1");
                contentBuilder.AddAttribute(2, "style", "cursor: pointer;");
                contentBuilder.AddAttribute(3, "oncontextmenu", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => ShowContextMenu(e, part)));

                // Left side: Part info
                contentBuilder.OpenElement(4, "div");
                contentBuilder.AddAttribute(5, "class", "d-flex flex-column");

                contentBuilder.OpenComponent<MudText>(6);
                contentBuilder.AddAttribute(7, "Typo", Typo.body2);
                contentBuilder.AddAttribute(8, "ChildContent", (RenderFragment)(b => b.AddContent(0, part.Name)));
                contentBuilder.CloseComponent();

                contentBuilder.OpenComponent<MudText>(9);
                contentBuilder.AddAttribute(10, "Typo", Typo.caption);
                contentBuilder.AddAttribute(11, "Color", Color.Secondary);
                contentBuilder.AddAttribute(12, "ChildContent", (RenderFragment)(b =>
                {
                    b.AddContent(0, $"{part.PartType} | {part.Quantity} {part.Unit}");
                    if (part.UnitCost > 0 || part.LaborCost > 0)
                    {
                        b.AddContent(1, $" | ${part.TotalCost:F2}");
                    }
                }));
                contentBuilder.CloseComponent();

                contentBuilder.CloseElement(); // div

                // Right side: Actions
                contentBuilder.OpenElement(13, "div");
                contentBuilder.AddAttribute(14, "class", "d-flex gap-1");

                contentBuilder.OpenComponent<MudIconButton>(15);
                contentBuilder.AddAttribute(16, "Icon", Icons.Material.Filled.Add);
                contentBuilder.AddAttribute(17, "Size", Size.Small);
                contentBuilder.AddAttribute(18, "Color", Color.Primary);
                contentBuilder.AddAttribute(19, "Title", Localization.Translate("AddChildPart"));
                contentBuilder.AddAttribute(20, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => OpenAddChildDialog(part)));
                contentBuilder.CloseComponent();

                contentBuilder.OpenComponent<MudIconButton>(21);
                contentBuilder.AddAttribute(22, "Icon", Icons.Material.Filled.Edit);
                contentBuilder.AddAttribute(23, "Size", Size.Small);
                contentBuilder.AddAttribute(24, "Color", Color.Info);
                contentBuilder.AddAttribute(25, "Title", Localization.Translate("EditPart"));
                contentBuilder.AddAttribute(26, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => OpenEditPartDialog(part)));
                contentBuilder.CloseComponent();

                contentBuilder.OpenComponent<MudIconButton>(27);
                contentBuilder.AddAttribute(28, "Icon", Icons.Material.Filled.Delete);
                contentBuilder.AddAttribute(29, "Size", Size.Small);
                contentBuilder.AddAttribute(30, "Color", Color.Error);
                contentBuilder.AddAttribute(31, "Title", Localization.Translate("DeletePart"));
                contentBuilder.AddAttribute(32, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => DeletePart(part.Id)));
                contentBuilder.CloseComponent();

                // Move up/down buttons for sibling reordering
                if (part.ParentPartId.HasValue || selectedTemplate?.RootParts.Count > 1)
                {
                    contentBuilder.OpenComponent<MudIconButton>(33);
                    contentBuilder.AddAttribute(34, "Icon", Icons.Material.Filled.ArrowUpward);
                    contentBuilder.AddAttribute(35, "Size", Size.Small);
                    contentBuilder.AddAttribute(36, "Title", Localization.Translate("MoveUp"));
                    contentBuilder.AddAttribute(37, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => MovePartUp(part)));
                    contentBuilder.CloseComponent();

                    contentBuilder.OpenComponent<MudIconButton>(38);
                    contentBuilder.AddAttribute(39, "Icon", Icons.Material.Filled.ArrowDownward);
                    contentBuilder.AddAttribute(40, "Size", Size.Small);
                    contentBuilder.AddAttribute(41, "Title", Localization.Translate("MoveDown"));
                    contentBuilder.AddAttribute(42, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, (e) => MovePartDown(part)));
                    contentBuilder.CloseComponent();
                }

                contentBuilder.CloseElement(); // div actions

                contentBuilder.CloseElement(); // div flex

                // Render children
                if (part.Children?.Any() == true)
                {
                    contentBuilder.OpenComponent<MudTreeViewItemToggleButton>(43);
                    contentBuilder.CloseComponent();

                    foreach (var child in part.Children.OrderBy(c => c.Position))
                    {
                        contentBuilder.AddContent(44, RenderTreeItem(child, depth + 1));
                    }
                }
            }));

            builder.CloseComponent(); // MudTreeViewItem
        };
    }

    private void ShowContextMenu(MouseEventArgs e, TemplatePartDto part)
    {
        contextMenuPart = part;
        contextMenuX = e.ClientX;
        contextMenuY = e.ClientY;
        showContextMenu = true;
        StateHasChanged();
    }

    private void HideContextMenu()
    {
        showContextMenu = false;
        contextMenuPart = null;
    }

    private void OpenAddChildDialog(TemplatePartDto parentPart)
    {
        HideContextMenu();
        if (selectedTemplate != null)
        {
            editingPart = new TemplatePartDto
            {
                ProductTemplateId = selectedTemplate.Id,
                ParentPartId = parentPart.Id,
                Quantity = 1,
                Position = (parentPart.Children?.Count ?? 0) + 1
            };
            showPartDialog = true;
        }
    }

    private async Task MovePartUp(TemplatePartDto part)
    {
        HideContextMenu();
        try
        {
            // Get siblings list
            var siblings = part.ParentPartId.HasValue
                ? FindPartById(selectedTemplate!.RootParts, part.ParentPartId.Value)?.Children
                : selectedTemplate?.RootParts;

            if (siblings == null) return;

            var orderedSiblings = siblings.OrderBy(p => p.Position).ToList();
            var currentIndex = orderedSiblings.FindIndex(p => p.Id == part.Id);

            if (currentIndex > 0)
            {
                // Swap positions
                var temp = orderedSiblings[currentIndex - 1].Position;
                orderedSiblings[currentIndex - 1].Position = part.Position;
                part.Position = temp;

                // Update both parts
                await TemplateService.UpdatePartAsync(orderedSiblings[currentIndex - 1]);
                await TemplateService.UpdatePartAsync(part);

                selectedTemplate = await TemplateService.GetTemplateByIdAsync(selectedTemplate!.Id);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error moving part: {ex.Message}", Severity.Error);
        }
    }

    private async Task MovePartDown(TemplatePartDto part)
    {
        HideContextMenu();
        try
        {
            // Get siblings list
            var siblings = part.ParentPartId.HasValue
                ? FindPartById(selectedTemplate!.RootParts, part.ParentPartId.Value)?.Children
                : selectedTemplate?.RootParts;

            if (siblings == null) return;

            var orderedSiblings = siblings.OrderBy(p => p.Position).ToList();
            var currentIndex = orderedSiblings.FindIndex(p => p.Id == part.Id);

            if (currentIndex < orderedSiblings.Count - 1)
            {
                // Swap positions
                var temp = orderedSiblings[currentIndex + 1].Position;
                orderedSiblings[currentIndex + 1].Position = part.Position;
                part.Position = temp;

                // Update both parts
                await TemplateService.UpdatePartAsync(orderedSiblings[currentIndex + 1]);
                await TemplateService.UpdatePartAsync(part);

                selectedTemplate = await TemplateService.GetTemplateByIdAsync(selectedTemplate!.Id);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error moving part: {ex.Message}", Severity.Error);
        }
    }

    private TemplatePartDto? FindPartById(List<TemplatePartDto> parts, int id)
    {
        foreach (var part in parts)
        {
            if (part.Id == id) return part;
            if (part.Children?.Any() == true)
            {
                var found = FindPartById(part.Children, id);
                if (found != null) return found;
            }
        }
        return null;
    }
}

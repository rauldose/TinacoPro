@page "/production-orders"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject ProductionOrderService OrderService
@inject ProductService ProductService
@inject LocalizationService Localization
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>@Localization.Translate("ProductionOrders") - TinacoPro</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@Localization.Translate("ProductionOrdersManagement")</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
           OnClick="ShowCreateForm" Class="mb-4">
    @Localization.Translate("NewProductionOrder")
</MudButton>

@if (orders == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (orders.Any())
{
    <MudTable Items="@orders" Hover="true" Striped="true" Dense="true" Elevation="2">
        <HeaderContent>
            <MudTh>@Localization.Translate("OrderNumber")</MudTh>
            <MudTh>@Localization.Translate("Product")</MudTh>
            <MudTh>@Localization.Translate("Quantity")</MudTh>
            <MudTh>@Localization.Translate("Status")</MudTh>
            <MudTh>@Localization.Translate("OrderDate")</MudTh>
            <MudTh>@Localization.Translate("CompletedDate")</MudTh>
            <MudTh>@Localization.Translate("Actions")</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@Localization.Translate("OrderNumber")">@context.OrderNumber</MudTd>
            <MudTd DataLabel="@Localization.Translate("Product")">@context.ProductName</MudTd>
            <MudTd DataLabel="@Localization.Translate("Quantity")">@context.Quantity</MudTd>
            <MudTd DataLabel="@Localization.Translate("Status")">
                @{
                    var chipColor = context.Status switch
                    {
                        "Pending" => Color.Warning,
                        "InProgress" => Color.Info,
                        "Completed" => Color.Success,
                        "Cancelled" => Color.Error,
                        _ => Color.Default
                    };
                }
                <MudChip T="string" Color="@chipColor" Size="Size.Small">@Localization.Translate(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="@Localization.Translate("OrderDate")">@context.OrderDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd DataLabel="@Localization.Translate("CompletedDate")">@(context.CompletedDate?.ToString("yyyy-MM-dd") ?? "-")</MudTd>
            <MudTd DataLabel="@Localization.Translate("Actions")">
                @if (context.Status == "Pending")
                {
                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" Color="Color.Info"
                                   OnClick="@(() => StartOrder(context.Id))" Title="@Localization.Translate("Start")" />
                }
                @if (context.Status == "InProgress")
                {
                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success"
                                   OnClick="@(() => CompleteOrder(context.Id))" Title="@Localization.Translate("Complete")" />
                }
                @if (context.Status == "Pending" || context.Status == "InProgress")
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => CancelOrder(context.Id))" Title="@Localization.Translate("Cancel")" />
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudAlert Severity="Severity.Info">@Localization.Translate("NoOrdersFound")</MudAlert>
}

<MudDialog @bind-Visible="showForm" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@Localization.Translate("NewProductionOrder")</MudText>
    </TitleContent>
    <DialogContent>
        <MudSelect @bind-Value="formModel.ProductId" Label="@Localization.Translate("Product")" Variant="Variant.Outlined" Class="mb-3" Required="true">
            @if (products != null)
            {
                @foreach (var product in products)
                {
                    <MudSelectItem Value="@product.Id">@product.Name (@product.Model)</MudSelectItem>
                }
            }
        </MudSelect>
        <MudNumericField @bind-Value="formModel.Quantity" Label="@Localization.Translate("Quantity")" Variant="Variant.Outlined" Class="mb-3" Min="1" Required="true" />
        <MudTextField @bind-Value="formModel.Notes" Label="@Localization.Translate("Notes")" Variant="Variant.Outlined" Lines="3" Class="mb-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideForm" Variant="Variant.Text">@Localization.Translate("Cancel")</MudButton>
        <MudButton OnClick="SaveOrder" Variant="Variant.Filled" Color="Color.Primary">@Localization.Translate("CreateOrder")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private IEnumerable<ProductionOrderDto>? orders;
    private IEnumerable<ProductDto>? products;
    private bool showForm = false;
    private OrderFormModel formModel = new();
    private DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        await LoadOrders();
        products = await ProductService.GetAllProductsAsync();
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadOrders()
    {
        orders = await OrderService.GetAllOrdersAsync();
    }

    private void ShowCreateForm()
    {
        formModel = new OrderFormModel();
        showForm = true;
    }

    private void HideForm()
    {
        showForm = false;
    }

    private async Task SaveOrder()
    {
        if (formModel.ProductId > 0)
        {
            var createDto = new CreateProductionOrderDto
            {
                ProductId = formModel.ProductId,
                Quantity = formModel.Quantity,
                Notes = formModel.Notes
            };
            await OrderService.CreateOrderAsync(createDto);
            HideForm();
            await LoadOrders();
        }
    }

    private async Task StartOrder(int orderId)
    {
        await OrderService.StartOrderAsync(orderId);
        await LoadOrders();
    }

    private async Task CompleteOrder(int orderId)
    {
        await OrderService.CompleteOrderAsync(orderId);
        await LoadOrders();
    }

    private async Task CancelOrder(int orderId)
    {
        await OrderService.CancelOrderAsync(orderId);
        await LoadOrders();
    }

    private class OrderFormModel
    {
        public int ProductId { get; set; }
        public int Quantity { get; set; } = 1;
        public string Notes { get; set; } = string.Empty;
    }
}

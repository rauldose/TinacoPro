@page "/products"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject ProductService ProductService
@inject ProductTemplateService TemplateService
@inject LocalizationService Localization
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Products - TinacoPro</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Product Catalog</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
           OnClick="ShowCreateForm" Class="mb-4">
    New Product
</MudButton>

@if (products == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (products.Any())
{
    <MudTable Items="@products" Hover="true" Striped="true" Dense="true" Elevation="2">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Model</MudTh>
            <MudTh>Capacity (L)</MudTh>
            <MudTh>Template</MudTh>
            <MudTh>Material Cost</MudTh>
            <MudTh>Labor Cost</MudTh>
            <MudTh>Total Cost</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Model">@context.Model</MudTd>
            <MudTd DataLabel="Capacity">@context.Capacity</MudTd>
            <MudTd DataLabel="Template">
                @if (context.TemplateName != null)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.AccountTree">
                        @context.TemplateName
                    </MudChip>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">No template</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Material Cost">$@context.MaterialCost.ToString("F2")</MudTd>
            <MudTd DataLabel="Labor Cost">$@context.LaborCost.ToString("F2")</MudTd>
            <MudTd DataLabel="Total Cost">
                <MudText Typo="Typo.body2" Color="Color.Success"><strong>$@context.TotalCost.ToString("F2")</strong></MudText>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@(context.IsActive ? Color.Success : Color.Default)" Size="Size.Small">
                    @(context.IsActive ? "Active" : "Inactive")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Info"
                               OnClick="@(() => ShowEditForm(context))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudAlert Severity="Severity.Info">No products found. Create your first product!</MudAlert>
}

<MudDialog @bind-Visible="showForm" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(editingProduct == null ? "New Product" : "Edit Product")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="formModel.Name" Label="Name" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="formModel.Model" Label="Model" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="formModel.Size" Label="Size" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="formModel.Capacity" Label="Capacity (Liters)" Variant="Variant.Outlined" Min="0" />
            </MudItem>
            <MudItem xs="12">
                <MudSelect @bind-Value="formModel.TemplateId" Label="Production Template (Optional)" 
                           Variant="Variant.Outlined" T="int?" Clearable="true"
                           HelperText="Select a template to define BOM and costs">
                    <MudSelectItem T="int?" Value="null">No Template</MudSelectItem>
                    @if (templates != null)
                    {
                        @foreach (var template in templates.Where(t => t.IsActive))
                        {
                            <MudSelectItem T="int?" Value="@template.Id">
                                @template.Name - @template.ModelType (Cost: $@((template.TotalMaterialCost + template.TotalLaborCost).ToString("F2")))
                            </MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="formModel.Description" Label="Description" Variant="Variant.Outlined" Lines="3" />
            </MudItem>
            <MudItem xs="12">
                <MudSwitch T="bool" @bind-Value="formModel.IsActive" Label="@Localization.Translate("Active")" Color="Color.Success" />
            </MudItem>
            
            @if (formModel.TemplateId.HasValue && templates != null)
            {
                var selectedTemplate = templates.FirstOrDefault(t => t.Id == formModel.TemplateId.Value);
                if (selectedTemplate != null)
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <MudText Typo="Typo.caption"><strong>Template Costs:</strong></MudText>
                            <MudText Typo="Typo.caption">Material Cost: $@selectedTemplate.TotalMaterialCost.ToString("F2")</MudText>
                            <MudText Typo="Typo.caption">Labor Cost: $@selectedTemplate.TotalLaborCost.ToString("F2")</MudText>
                            <MudText Typo="Typo.caption"><strong>Total: $@((selectedTemplate.TotalMaterialCost + selectedTemplate.TotalLaborCost).ToString("F2"))</strong></MudText>
                        </MudAlert>
                    </MudItem>
                }
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideForm" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="SaveProduct" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private IEnumerable<ProductDto>? products;
    private IEnumerable<ProductTemplateDto>? templates;
    private bool showForm = false;
    private ProductDto? editingProduct;
    private ProductFormModel formModel = new();

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        await LoadProducts();
        await LoadTemplates();
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadProducts()
    {
        products = await ProductService.GetAllProductsAsync();
    }

    private async Task LoadTemplates()
    {
        templates = await TemplateService.GetAllTemplatesAsync();
    }

    private void ShowCreateForm()
    {
        editingProduct = null;
        formModel = new ProductFormModel();
        showForm = true;
    }

    private void ShowEditForm(ProductDto product)
    {
        editingProduct = product;
        formModel = new ProductFormModel
        {
            Name = product.Name,
            Model = product.Model,
            Size = product.Size,
            Capacity = product.Capacity,
            Description = product.Description,
            IsActive = product.IsActive,
            TemplateId = product.TemplateId
        };
        showForm = true;
    }

    private void HideForm()
    {
        showForm = false;
        editingProduct = null;
    }

    private async Task SaveProduct()
    {
        try
        {
            if (editingProduct == null)
            {
                var createDto = new CreateProductDto
                {
                    Name = formModel.Name,
                    Model = formModel.Model,
                    Size = formModel.Size,
                    Capacity = formModel.Capacity,
                    Description = formModel.Description,
                    TemplateId = formModel.TemplateId
                };
                await ProductService.CreateProductAsync(createDto);
                Snackbar.Add("Product created successfully!", Severity.Success);
            }
            else
            {
                editingProduct.Name = formModel.Name;
                editingProduct.Model = formModel.Model;
                editingProduct.Size = formModel.Size;
                editingProduct.Capacity = formModel.Capacity;
                editingProduct.Description = formModel.Description;
                editingProduct.IsActive = formModel.IsActive;
                editingProduct.TemplateId = formModel.TemplateId;
                await ProductService.UpdateProductAsync(editingProduct);
                Snackbar.Add("Product updated successfully!", Severity.Success);
            }
            
            HideForm();
            await LoadProducts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving product: {ex.Message}", Severity.Error);
        }
    }

    private class ProductFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public string Size { get; set; } = string.Empty;
        public decimal Capacity { get; set; }
        public string Description { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
        public int? TemplateId { get; set; }
    }
}

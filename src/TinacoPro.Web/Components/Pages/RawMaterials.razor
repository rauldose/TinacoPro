@page "/raw-materials"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject RawMaterialService MaterialService
@inject LocalizationService Localization
@implements IDisposable

<PageTitle>@Localization.Translate("RawMaterialsInventory") - TinacoPro</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@Localization.Translate("RawMaterialsInventory")</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
           OnClick="ShowCreateForm" Class="mb-4">
    @Localization.Translate("NewMaterial")
</MudButton>

@if (materials == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    @if (materials.Any(m => m.IsLowStock && m.IsActive))
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4" Icon="@Icons.Material.Filled.Warning">
            <strong>@Localization.Translate("LowStockAlert")</strong> @materials.Count(m => m.IsLowStock && m.IsActive) @Localization.Translate("LowStockAlertCount")
        </MudAlert>
    }

    @if (materials.Any())
    {
        <MudTable Items="@materials" Hover="true" Striped="true" Dense="true" Elevation="2">
            <HeaderContent>
                <MudTh>@Localization.Translate("Name")</MudTh>
                <MudTh>@Localization.Translate("Code")</MudTh>
                <MudTh>@Localization.Translate("Category")</MudTh>
                <MudTh>@Localization.Translate("Unit")</MudTh>
                <MudTh>@Localization.Translate("CurrentStock")</MudTh>
                <MudTh>@Localization.Translate("MinStock")</MudTh>
                <MudTh>@Localization.Translate("UnitCost")</MudTh>
                <MudTh>@Localization.Translate("Status")</MudTh>
                <MudTh>@Localization.Translate("Actions")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    @context.Name
                    @if (context.IsLowStock && context.IsActive)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Code">@context.Code</MudTd>
                <MudTd DataLabel="Category">@context.Category</MudTd>
                <MudTd DataLabel="Unit">@context.Unit</MudTd>
                <MudTd DataLabel="Current Stock">
                    <MudChip T="string" Size="Size.Small" Color="@(context.IsLowStock ? Color.Error : Color.Default)">
                        @context.CurrentStock.ToString("N2")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Min Stock">@context.MinimumStock.ToString("N2")</MudTd>
                <MudTd DataLabel="Unit Cost">$@context.UnitCost.ToString("N2")</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Color="@(context.IsActive ? Color.Success : Color.Default)" Size="Size.Small">
                        @(context.IsActive ? Localization.Translate("Active") : Localization.Translate("Inactive"))
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="@Localization.Translate("Actions")">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Info"
                                   OnClick="@(() => ShowEditForm(context))" Title="@Localization.Translate("Edit")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" Color="Color.Success"
                                   OnClick="@(() => ShowStockInForm(context))" Title="@Localization.Translate("StockIn")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Remove" Size="Size.Small" Color="Color.Warning"
                                   OnClick="@(() => ShowStockOutForm(context))" Title="@Localization.Translate("StockOut")" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Info">@Localization.Translate("NoMaterialsFound")</MudAlert>
    }
}

<MudDialog @bind-Visible="showForm" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(editingMaterial == null ? Localization.Translate("NewMaterial") : Localization.Translate("EditMaterial"))
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="formModel.Name" Label="@Localization.Translate("Name")" Variant="Variant.Outlined" Class="mb-3" Required="true" />
        <MudTextField @bind-Value="formModel.Code" Label="@Localization.Translate("Code")" Variant="Variant.Outlined" Class="mb-3" Required="true" />
        <MudTextField @bind-Value="formModel.Unit" Label="@Localization.Translate("UnitFormat")" Variant="Variant.Outlined" Class="mb-3" Required="true" />
        <MudNumericField @bind-Value="formModel.MinimumStock" Label="@Localization.Translate("MinimumStock")" Variant="Variant.Outlined" Class="mb-3" Min="0" />
        <MudNumericField @bind-Value="formModel.UnitCost" Label="@Localization.Translate("UnitCost")" Variant="Variant.Outlined" Class="mb-3" Min="0" Format="N2" />
        <MudSwitch T="bool" @bind-Value="formModel.IsActive" Label="@Localization.Translate("Active")" Color="Color.Success" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideForm" Variant="Variant.Text">@Localization.Translate("Cancel")</MudButton>
        <MudButton OnClick="SaveMaterial" Variant="Variant.Filled" Color="Color.Primary">@Localization.Translate("Save")</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="showStockForm" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(isStockIn ? Localization.Translate("StockIn") : Localization.Translate("StockOut")) - @selectedMaterial?.Name
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-3">
            @Localization.Translate("CurrentStock"): <strong>@selectedMaterial?.CurrentStock.ToString("N2") @selectedMaterial?.Unit</strong>
        </MudAlert>
        <MudNumericField @bind-Value="stockQuantity" Label="@Localization.Translate("Quantity")" Variant="Variant.Outlined" Class="mb-3" Min="0" Required="true" />
        <MudTextField @bind-Value="stockReason" Label="@Localization.Translate("Reason")" Variant="Variant.Outlined" Lines="2" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideStockForm" Variant="Variant.Text">@Localization.Translate("Cancel")</MudButton>
        <MudButton OnClick="SaveStockMovement" Variant="Variant.Filled" Color="@(isStockIn ? Color.Success : Color.Warning)">
            @(isStockIn ? Localization.Translate("AddStock") : Localization.Translate("RemoveStock"))
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private IEnumerable<RawMaterialDto>? materials;
    private bool showForm = false;
    private bool showStockForm = false;
    private bool isStockIn = true;
    private RawMaterialDto? editingMaterial;
    private RawMaterialDto? selectedMaterial;
    private MaterialFormModel formModel = new();
    private decimal stockQuantity = 0;
    private string stockReason = string.Empty;
    private DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        await LoadMaterials();
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadMaterials()
    {
        materials = await MaterialService.GetAllMaterialsAsync();
    }

    private void ShowCreateForm()
    {
        editingMaterial = null;
        formModel = new MaterialFormModel();
        showForm = true;
    }

    private void ShowEditForm(RawMaterialDto material)
    {
        editingMaterial = material;
        formModel = new MaterialFormModel
        {
            Name = material.Name,
            Code = material.Code,
            Unit = material.Unit,
            MinimumStock = material.MinimumStock,
            UnitCost = material.UnitCost,
            IsActive = material.IsActive
        };
        showForm = true;
    }

    private void HideForm()
    {
        showForm = false;
        editingMaterial = null;
    }

    private async Task SaveMaterial()
    {
        if (editingMaterial == null)
        {
            var createDto = new CreateRawMaterialDto
            {
                Name = formModel.Name,
                Code = formModel.Code,
                Unit = formModel.Unit,
                MinimumStock = formModel.MinimumStock,
                UnitCost = formModel.UnitCost
            };
            await MaterialService.CreateMaterialAsync(createDto);
        }
        else
        {
            editingMaterial.Name = formModel.Name;
            editingMaterial.Code = formModel.Code;
            editingMaterial.Unit = formModel.Unit;
            editingMaterial.MinimumStock = formModel.MinimumStock;
            editingMaterial.UnitCost = formModel.UnitCost;
            editingMaterial.IsActive = formModel.IsActive;
            await MaterialService.UpdateMaterialAsync(editingMaterial);
        }
        
        HideForm();
        await LoadMaterials();
    }

    private void ShowStockInForm(RawMaterialDto material)
    {
        selectedMaterial = material;
        isStockIn = true;
        stockQuantity = 0;
        stockReason = string.Empty;
        showStockForm = true;
    }

    private void ShowStockOutForm(RawMaterialDto material)
    {
        selectedMaterial = material;
        isStockIn = false;
        stockQuantity = 0;
        stockReason = string.Empty;
        showStockForm = true;
    }

    private void HideStockForm()
    {
        showStockForm = false;
        selectedMaterial = null;
    }

    private async Task SaveStockMovement()
    {
        if (selectedMaterial != null && stockQuantity > 0)
        {
            try
            {
                await MaterialService.AdjustStockAsync(selectedMaterial.Id, stockQuantity, isStockIn);
                HideStockForm();
                await LoadMaterials();
            }
            catch (InvalidOperationException)
            {
                // Keep dialog open and show error - stock quantity exceeds available stock
                stockQuantity = selectedMaterial.CurrentStock;
            }
        }
    }

    private class MaterialFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string Unit { get; set; } = string.Empty;
        public decimal MinimumStock { get; set; }
        public decimal UnitCost { get; set; }
        public bool IsActive { get; set; } = true;
    }
}

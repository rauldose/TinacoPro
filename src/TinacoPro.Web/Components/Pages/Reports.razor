@page "/reports"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@inject ProductionOrderService OrderService
@inject RawMaterialService MaterialService
@inject ProductService ProductService
@inject ExcelExportService ExcelService
@inject IJSRuntime JS

<PageTitle>Reports - TinacoPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Reports & Analytics</MudText>

    <!-- Report Designer Card -->
    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">Report Designer</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudSelect T="string" Label="Report Type" @bind-Value="selectedReportType" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("production")">Production Summary</MudSelectItem>
                        <MudSelectItem Value="@("inventory")">Inventory Status</MudSelectItem>
                        <MudSelectItem Value="@("materials")">Raw Materials Usage</MudSelectItem>
                        <MudSelectItem Value="@("orders")">Orders Analysis</MudSelectItem>
                        <MudSelectItem Value="@("custom")">Custom Report</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="Start Date" @bind-Date="startDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="End Date" @bind-Date="endDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.PlayArrow" 
                               OnClick="GenerateReport"
                               FullWidth="true"
                               Class="mt-1">
                        Generate
                    </MudButton>
                </MudItem>
            </MudGrid>

            @if (!string.IsNullOrEmpty(selectedReportType))
            {
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.h6" Class="mb-3">Report Options</MudText>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="includeCharts" Label="Include Charts" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="includeDetails" Label="Include Details" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="groupByProduct" Label="Group by Product" Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Download">
                Export PDF
            </MudButton>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.TableChart"
                       OnClick="ExportToExcel"
                       Disabled="@(!reportGenerated)">
                Export Excel
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Info" StartIcon="@Icons.Material.Filled.Save">
                Save Template
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (reportGenerated)
    {
        <!-- Production Summary Report -->
        @if (selectedReportType == "production")
        {
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Production Summary Report</MudText>
                        <MudText Typo="Typo.body2">@startDate?.ToString("MMM dd, yyyy") - @endDate?.ToString("MMM dd, yyyy")</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (orders != null)
                    {
                        var filteredOrders = orders.Where(o => o.Status == "Completed" 
                            && o.CompletedDate >= startDate 
                            && o.CompletedDate <= endDate).ToList();

                        <MudGrid>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@filteredOrders.Count</MudText>
                                    <MudText Typo="Typo.body2">Orders Completed</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Success">@filteredOrders.Sum(o => o.Quantity)</MudText>
                                    <MudText Typo="Typo.body2">Total Units</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Info">@filteredOrders.GroupBy(o => o.ProductName).Count()</MudText>
                                    <MudText Typo="Typo.body2">Product Types</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Warning">@(filteredOrders.Any() ? (filteredOrders.Sum(o => o.Quantity) / (double)filteredOrders.Count).ToString("F1") : "0")</MudText>
                                    <MudText Typo="Typo.body2">Avg Units/Order</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @if (includeDetails && filteredOrders.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6" Class="mb-3">Production Details</MudText>
                            <MudTable Items="@filteredOrders" Hover="true" Striped="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Order #</MudTh>
                                    <MudTh>Product</MudTh>
                                    <MudTh>Quantity</MudTh>
                                    <MudTh>Completed Date</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Order #">@context.OrderNumber</MudTd>
                                    <MudTd DataLabel="Product">@context.ProductName</MudTd>
                                    <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
                                    <MudTd DataLabel="Completed">@context.CompletedDate?.ToString("MMM dd, yyyy")</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    }
                </MudCardContent>
            </MudCard>
        }

        <!-- Inventory Status Report -->
        @if (selectedReportType == "inventory")
        {
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Inventory Status Report</MudText>
                        <MudText Typo="Typo.body2">Current Status as of @DateTime.Now.ToString("MMM dd, yyyy")</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (materials != null)
                    {
                        var lowStockItems = materials.Where(m => m.IsLowStock).ToList();
                        var adequateStock = materials.Where(m => !m.IsLowStock).ToList();

                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@materials.Count()</MudText>
                                    <MudText Typo="Typo.body2">Total Materials</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Error">@lowStockItems.Count</MudText>
                                    <MudText Typo="Typo.body2">Low Stock Alerts</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Success">@adequateStock.Count</MudText>
                                    <MudText Typo="Typo.body2">Adequate Stock</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @if (lowStockItems.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudAlert Severity="Severity.Warning" Class="mb-3">
                                <strong>Attention Required:</strong> @lowStockItems.Count materials need restocking
                            </MudAlert>
                            <MudTable Items="@lowStockItems" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Material</MudTh>
                                    <MudTh>Code</MudTh>
                                    <MudTh>Current Stock</MudTh>
                                    <MudTh>Minimum Stock</MudTh>
                                    <MudTh>Shortage</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Material">@context.Name</MudTd>
                                    <MudTd DataLabel="Code">@context.Code</MudTd>
                                    <MudTd DataLabel="Current">@context.CurrentStock @context.Unit</MudTd>
                                    <MudTd DataLabel="Minimum">@context.MinimumStock @context.Unit</MudTd>
                                    <MudTd DataLabel="Shortage">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">
                                            @((context.MinimumStock - context.CurrentStock).ToString("F1")) @context.Unit
                                        </MudChip>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    }
                </MudCardContent>
            </MudCard>
        }

        <!-- Custom Report Message -->
        @if (selectedReportType == "custom")
        {
            <MudCard>
                <MudCardContent>
                    <MudAlert Severity="Severity.Info">
                        <strong>Custom Report Builder</strong>
                        <br />
                        Design your own reports by selecting specific metrics, groupings, and visualizations.
                        This feature allows you to create tailored reports for your specific business needs.
                    </MudAlert>
                </MudCardContent>
            </MudCard>
        }
    }
</MudContainer>

@code {
    private IEnumerable<ProductionOrderDto>? orders;
    private IEnumerable<RawMaterialDto>? materials;
    private IEnumerable<ProductDto>? products;
    private bool isLoading = false;
    private bool reportGenerated = false;
    
    private string selectedReportType = "production";
    private DateTime? startDate = DateTime.UtcNow.AddMonths(-1);
    private DateTime? endDate = DateTime.UtcNow;
    
    private bool includeCharts = true;
    private bool includeDetails = true;
    private bool groupByProduct = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        orders = await OrderService.GetAllOrdersAsync();
        materials = await MaterialService.GetAllMaterialsAsync();
        products = await ProductService.GetAllProductsAsync();
        isLoading = false;
    }

    private async Task GenerateReport()
    {
        isLoading = true;
        await Task.Delay(500); // Simulate report generation
        reportGenerated = true;
        isLoading = false;
    }

    private async Task ExportToExcel()
    {
        if (!reportGenerated) return;

        byte[] fileBytes;
        string fileName;

        if (selectedReportType == "production")
        {
            fileBytes = ExcelService.ExportProductionReport(orders!, startDate, endDate);
            fileName = $"Production_Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }
        else if (selectedReportType == "inventory")
        {
            fileBytes = ExcelService.ExportInventoryReport(materials!);
            fileName = $"Inventory_Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }
        else
        {
            // For other report types, use a generic filename
            fileBytes = ExcelService.ExportProductionReport(orders!, startDate, endDate);
            fileName = $"Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }

        // Download file using JavaScript interop
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("downloadFile", fileName, base64);
    }
}

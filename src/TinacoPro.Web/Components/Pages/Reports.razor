@page "/reports"
@rendermode InteractiveServer
@using TinacoPro.Application.Services
@using TinacoPro.Application.DTOs
@using TinacoPro.Web.Services
@inject ProductionOrderService OrderService
@inject RawMaterialService MaterialService
@inject ProductService ProductService
@inject ExcelExportService ExcelService
@inject IJSRuntime JS
@inject LocalizationService Localization
@implements IDisposable

<PageTitle>@Localization.Translate("ReportsAnalytics") - TinacoPro</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">@Localization.Translate("ReportsAnalytics")</MudText>

    <!-- Report Designer Card -->
    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">@Localization.Translate("ReportDesigner")</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudSelect T="string" Label="@Localization.Translate("ReportType")" @bind-Value="selectedReportType" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("production")">@Localization.Translate("ProductionSummaryReport")</MudSelectItem>
                        <MudSelectItem Value="@("inventory")">@Localization.Translate("InventoryStatusReport")</MudSelectItem>
                        <MudSelectItem Value="@("materials")">@Localization.Translate("RawMaterialsUsage")</MudSelectItem>
                        <MudSelectItem Value="@("orders")">@Localization.Translate("OrdersAnalysis")</MudSelectItem>
                        <MudSelectItem Value="@("custom")">@Localization.Translate("CustomReport")</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="@Localization.Translate("StartDate")" @bind-Date="startDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="@Localization.Translate("EndDate")" @bind-Date="endDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.PlayArrow" 
                               OnClick="GenerateReport"
                               FullWidth="true"
                               Class="mt-1">
                        @Localization.Translate("Generate")
                    </MudButton>
                </MudItem>
            </MudGrid>

            @if (!string.IsNullOrEmpty(selectedReportType))
            {
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.h6" Class="mb-3">@Localization.Translate("ReportOptions")</MudText>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="includeCharts" Label="@Localization.Translate("IncludeCharts")" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="includeDetails" Label="@Localization.Translate("IncludeDetails")" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCheckBox T="bool" @bind-Value="groupByProduct" Label="@Localization.Translate("GroupByProduct")" Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Download">
                @Localization.Translate("ExportPDF")
            </MudButton>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.TableChart"
                       OnClick="ExportToExcel"
                       Disabled="@(!reportGenerated)">
                @Localization.Translate("ExportExcel")
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Info" StartIcon="@Icons.Material.Filled.Save">
                @Localization.Translate("SaveTemplate")
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (reportGenerated)
    {
        <!-- Production Summary Report -->
        @if (selectedReportType == "production")
        {
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">@Localization.Translate("ProductionSummaryReportTitle")</MudText>
                        <MudText Typo="Typo.body2">@startDate?.ToString("MMM dd, yyyy") - @endDate?.ToString("MMM dd, yyyy")</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (orders != null)
                    {
                        var filteredOrders = orders.Where(o => o.Status == "Completed" 
                            && o.CompletedDate >= startDate 
                            && o.CompletedDate <= endDate).ToList();

                        <MudGrid>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@filteredOrders.Count</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("OrdersCompleted")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Success">@filteredOrders.Sum(o => o.Quantity)</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("TotalUnits")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Info">@filteredOrders.GroupBy(o => o.ProductName).Count()</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("ProductTypes")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Warning">@(filteredOrders.Any() ? (filteredOrders.Sum(o => o.Quantity) / (double)filteredOrders.Count).ToString("F1") : "0")</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("AvgUnitsOrder")</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @if (includeDetails && filteredOrders.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6" Class="mb-3">@Localization.Translate("ProductionDetails")</MudText>
                            <MudTable Items="@filteredOrders" Hover="true" Striped="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>@Localization.Translate("OrderNumber")</MudTh>
                                    <MudTh>@Localization.Translate("Product")</MudTh>
                                    <MudTh>@Localization.Translate("Quantity")</MudTh>
                                    <MudTh>@Localization.Translate("CompletedDate")</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Order #">@context.OrderNumber</MudTd>
                                    <MudTd DataLabel="Product">@context.ProductName</MudTd>
                                    <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
                                    <MudTd DataLabel="Completed">@context.CompletedDate?.ToString("MMM dd, yyyy")</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    }
                </MudCardContent>
            </MudCard>
        }

        <!-- Inventory Status Report -->
        @if (selectedReportType == "inventory")
        {
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">@Localization.Translate("InventoryStatusReportTitle")</MudText>
                        <MudText Typo="Typo.body2">@Localization.Translate("CurrentStatusAsOf") @DateTime.Now.ToString("MMM dd, yyyy")</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (materials != null)
                    {
                        var lowStockItems = materials.Where(m => m.IsLowStock).ToList();
                        var adequateStock = materials.Where(m => !m.IsLowStock).ToList();

                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@materials.Count()</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("TotalMaterials")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Error">@lowStockItems.Count</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("LowStockAlerts")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-4" Elevation="2">
                                    <MudText Typo="Typo.h6" Color="Color.Success">@adequateStock.Count</MudText>
                                    <MudText Typo="Typo.body2">@Localization.Translate("AdequateStock")</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @if (lowStockItems.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudAlert Severity="Severity.Warning" Class="mb-3">
                                <strong>@Localization.Translate("AttentionRequired")</strong> @lowStockItems.Count @Localization.Translate("MaterialsNeedRestocking")
                            </MudAlert>
                            <MudTable Items="@lowStockItems" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>@Localization.Translate("Material")</MudTh>
                                    <MudTh>@Localization.Translate("Code")</MudTh>
                                    <MudTh>@Localization.Translate("CurrentStock")</MudTh>
                                    <MudTh>@Localization.Translate("MinimumStock")</MudTh>
                                    <MudTh>@Localization.Translate("Shortage")</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Material">@context.Name</MudTd>
                                    <MudTd DataLabel="Code">@context.Code</MudTd>
                                    <MudTd DataLabel="Current">@context.CurrentStock @context.Unit</MudTd>
                                    <MudTd DataLabel="Minimum">@context.MinimumStock @context.Unit</MudTd>
                                    <MudTd DataLabel="Shortage">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">
                                            @((context.MinimumStock - context.CurrentStock).ToString("F1")) @context.Unit
                                        </MudChip>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    }
                </MudCardContent>
            </MudCard>
        }

        <!-- Custom Report Message -->
        @if (selectedReportType == "custom")
        {
            <MudCard>
                <MudCardContent>
                    <MudAlert Severity="Severity.Info">
                        <strong>@Localization.Translate("CustomReportBuilder")</strong>
                        <br />
                        @Localization.Translate("CustomReportDescription")
                    </MudAlert>
                </MudCardContent>
            </MudCard>
        }
    }
</MudContainer>

@code {
    private IEnumerable<ProductionOrderDto>? orders;
    private IEnumerable<RawMaterialDto>? materials;
    private IEnumerable<ProductDto>? products;
    private bool isLoading = false;
    private bool reportGenerated = false;
    
    private string selectedReportType = "production";
    private DateTime? startDate = DateTime.UtcNow.AddMonths(-1);
    private DateTime? endDate = DateTime.UtcNow;
    
    private bool includeCharts = true;
    private bool includeDetails = true;
    private bool groupByProduct = false;

    protected override async Task OnInitializedAsync()
    {
        Localization.OnLanguageChanged += HandleLanguageChanged;
        isLoading = true;
        orders = await OrderService.GetAllOrdersAsync();
        materials = await MaterialService.GetAllMaterialsAsync();
        products = await ProductService.GetAllProductsAsync();
        isLoading = false;
    }

    private async void HandleLanguageChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task GenerateReport()
    {
        isLoading = true;
        await Task.Delay(500); // Simulate report generation
        reportGenerated = true;
        isLoading = false;
    }

    private async Task ExportToExcel()
    {
        if (!reportGenerated) return;

        byte[] fileBytes;
        string fileName;

        if (selectedReportType == "production")
        {
            fileBytes = ExcelService.ExportProductionReport(orders!, startDate, endDate);
            fileName = $"Production_Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }
        else if (selectedReportType == "inventory")
        {
            fileBytes = ExcelService.ExportInventoryReport(materials!);
            fileName = $"Inventory_Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }
        else
        {
            // For other report types, use a generic filename
            fileBytes = ExcelService.ExportProductionReport(orders!, startDate, endDate);
            fileName = $"Report_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        }

        // Download file using JavaScript interop
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("downloadFile", fileName, base64);
    }
}
